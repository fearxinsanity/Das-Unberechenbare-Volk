@startuml SimulationStep
title Einzelner Simulationsschritt (mit Skandal)

participant ":SimulationController" as SimCtrl
participant ":SimulationEngine" as Engine
participant ":SimulationState" as State
participant ":ScandalScheduler" as Scandal
participant ":CSVLoader" as CSV
participant ":ScandalImpactCalculator" as Impact
participant ":VoterBehavior" as Behavior
participant ":VoterPopulation" as Voters
participant ":PartyRegistry" as Registry
participant ":Party" as Party
participant ":DashboardController" as Dashboard

SimCtrl -> Engine: runSimulationStep()
activate Engine

Engine -> State: incrementStep()
activate State
State --> Engine
deactivate State

Engine -> State: getActiveScandals()
activate State
State --> Engine: activeScandals
deactivate State

Engine -> Engine: removeOldScandals()
activate Engine
deactivate Engine

Engine -> Scandal: shouldScandalOccur()
activate Scandal
Scandal --> Engine: true
deactivate Scandal

Engine -> Engine: triggerNewScandal()
activate Engine

Engine -> CSV: getRandomScandal()
activate CSV
CSV --> Engine: scandal
deactivate CSV

Engine -> Registry: getRandomParty()
activate Registry
Registry --> Engine: targetParty
deactivate Registry

Engine -> Party: incrementScandalCount()
activate Party
Party --> Engine
deactivate Party

Engine -> State: addScandal(event)
activate State
State --> Engine
deactivate State

deactivate Engine

Engine -> Impact: calculateAcutePressure(scandals, parties, step)
activate Impact
Impact --> Engine: pressures[]
deactivate Impact

Engine -> Impact: processRecovery(parties, population)
activate Impact
Impact --> Engine
deactivate Impact

Engine -> Behavior: processVoterDecisions(population, parties, params, pressures, impactCalc)
activate Behavior

Behavior -> Behavior: updateZeitgeist()
activate Behavior
deactivate Behavior

Behavior -> Behavior: createPartyCache(parties)
activate Behavior
deactivate Behavior

par für jeden Wähler (parallel)
    Behavior -> Behavior: applyOpinionDrift(voter)
    activate Behavior
    deactivate Behavior

    Behavior -> Behavior: calculateSwitchProbability()
    activate Behavior
    deactivate Behavior

    alt Wechselentscheidung getroffen
        Behavior -> Behavior: findBestTargetParty()
        activate Behavior
        deactivate Behavior

        Behavior -> Voters: setPartyIndex(voterIdx, targetParty)
        activate Voters
        Voters --> Behavior
        deactivate Voters
    end
end

Behavior --> Engine: transitions[]
deactivate Behavior

Engine -> Engine: recalculateCounts()
activate Engine

loop für jede Partei
    Engine -> Voters: countSupporters(partyIdx)
    activate Voters
    Voters --> Engine: count
    deactivate Voters

    Engine -> Party: setCurrentSupporterCount(count)
    activate Party
    Party --> Engine
    deactivate Party
end

deactivate Engine

Engine --> SimCtrl: transitions
deactivate Engine

SimCtrl -> Engine: getLastScandal()
activate Engine
Engine -> State: consumeLastScandal()
activate State
State --> Engine: scandalEvent
deactivate State
Engine --> SimCtrl: scandalEvent
deactivate Engine

SimCtrl -> Engine: getParties()
activate Engine
Engine --> SimCtrl: parties
deactivate Engine

SimCtrl -> Dashboard: updateDashboard(parties, transitions, scandal, step)
activate Dashboard
Dashboard --> SimCtrl
deactivate Dashboard

@enduml
