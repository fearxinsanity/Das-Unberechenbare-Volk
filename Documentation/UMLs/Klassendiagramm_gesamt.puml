@startuml
skinparam classAttributeIconSize 0
skinparam classFontSize 10
skinparam linetype ortho
skinparam packageStyle rectangle

' ===== CONTROLLER LAYER =====
package "de.schulprojekt.duv.controller" #LIGHTSALMON {
    class SimulationController {
        - {static} LOGGER : Logger
        - {static} DEFAULT_POPULATION : int
        - {static} DEFAULT_MEDIA_INFLUENCE : double
        - {static} DEFAULT_VOLATILITY : double
        - {static} DEFAULT_SCANDAL_PROB : double
        - {static} DEFAULT_LOYALTY : double
        - {static} DEFAULT_TICK_RATE : int
        - {static} DEFAULT_CHAOS : double
        - {static} DEFAULT_PARTIES : int
        - {static} DEFAULT_BUDGET_WEIGHT : double
        - engine : SimulationEngine
        - view : DashboardController
        - executorService : ScheduledExecutorService
        - simulationTask : ScheduledFuture<?>
        - isRunning : AtomicBoolean
        + SimulationController(view : DashboardController)
        + getCurrentParameters() : SimulationParameters
        + getParties() : List<Party>
        + isRunning() : boolean
        + startSimulation() : void
        + pauseSimulation() : void
        + resetSimulation() : void
        + updateSimulationSpeed(factor : int) : void
        + updateAllParameters(p : SimulationParameters) : void
        + shutdown() : void
        - stopCurrentTask() : void
        - scheduleTask() : void
        - runLoopStep() : void
    }
}

' ===== VIEW LAYER =====
package "de.schulprojekt.duv.view" #LIGHTPINK {
    class Main {
        - {static} LOGGER : Logger
        - {static} APP_TITLE : String
        - {static} WINDOW_WIDTH : int
        - {static} WINDOW_HEIGHT : int
        - {static} FXML_START_VIEW : String
        - {static} CSS_COMMON : String
        - {static} CSS_START : String
        - {static} ICON_PATH : String
        + {static} main(args : String[]) : void
        + start(primaryStage : Stage) : void
        - loadStylesheet(scene : Scene, resourcePath : String) : void
        - setAppIcon(stage : Stage) : void
    }
}

package "de.schulprojekt.duv.view.controllers" #PLUM {
    class DashboardController {
        + DashboardController()
        + updateDashboard(parties : List<Party>, transitions : List<VoterTransition>, scandal : ScandalEvent, step : int) : void
        + shutdown() : void
    }

    class StartController {
        + StartController()
        + initialize() : void
        + handleStartSimulation() : void
    }

    class StatisticsController {
        + StatisticsController()
        + updateStatistics(parties : List<Party>) : void
    }

    class ParliamentController {
        + ParliamentController()
        + renderParliament(parties : List<Party>) : void
    }
}

' ===== MODEL LAYER =====
package "de.schulprojekt.duv.model.core" #LIGHTBLUE {
    class SimulationEngine {
        - state : SimulationState
        - parameters : SimulationParameters
        - csvLoader : CSVLoader
        - random : Random
        - distributionProvider : DistributionProvider
        - partyRegistry : PartyRegistry
        - voterPopulation : VoterPopulation
        - voterBehavior : VoterBehavior
        - scandalScheduler : ScandalScheduler
        - impactCalculator : ScandalImpactCalculator
        + SimulationEngine(params : SimulationParameters)
        + getParties() : List<Party>
        + getLastScandal() : ScandalEvent
        + getCurrentStep() : int
        + getParameters() : SimulationParameters
        + initializeSimulation() : void
        + runSimulationStep() : List<VoterTransition>
        + updateParameters(newParams : SimulationParameters) : void
        + resetState() : void
        - triggerNewScandal() : void
        - recalculateCounts() : void
    }

    class SimulationState {
        - currentStep : int
        - activeScandals : List<ScandalEvent>
        - lastScandal : ScandalEvent
        + SimulationState()
        + getCurrentStep() : int
        + getActiveScandals() : List<ScandalEvent>
        + incrementStep() : void
        + addScandal(event : ScandalEvent) : void
        + consumeLastScandal() : ScandalEvent
        + reset() : void
    }

    class SimulationParameters <<record>> {
        + populationSize : int
        + mediaInfluence : double
        + volatility : double
        + scandalProbability : double
        + loyalty : double
        + tickRate : int
        + chaos : double
        + partyCount : int
        + budgetWeight : double
    }
}

package "de.schulprojekt.duv.model.party" #LIGHTGREEN {
    class Party {
        - name : String
        - abbreviation : String
        - colorCode : String
        - politicalPosition : double
        - campaignBudget : double
        - currentSupporterCount : int
        - scandalCount : int
        + Party(name : String, abbreviation : String, colorCode : String, politicalPosition : double, campaignBudget : double, currentSupporterCount : int)
        + getName() : String
        + getAbbreviation() : String
        + getColorCode() : String
        + getPoliticalPosition() : double
        + getCampaignBudget() : double
        + getCurrentSupporterCount() : int
        + getScandalCount() : int
        + setCurrentSupporterCount(count : int) : void
        + getPoliticalOrientationName() : String
        + incrementScandalCount() : void
    }

    class PartyRegistry {
        - csvLoader : CSVLoader
        - parties : List<Party>
        + PartyRegistry(csvLoader : CSVLoader)
        + getParties() : List<Party>
        + initializeParties(params : SimulationParameters, distProvider : DistributionProvider) : void
        + updateSupporterCounts(counts : int[]) : void
    }

    class PartyTemplate <<record>> {
        + name : String
        + abbreviation : String
        + colorCode : String
        + politicalPosition : double
    }
}

package "de.schulprojekt.duv.model.scandal" #LIGHTYELLOW {
    class Scandal <<record>> {
        + id : int
        + type : String
        + title : String
        + description : String
        + strength : double
        + toString() : String
    }

    class ScandalEvent <<record>> {
        + scandal : Scandal
        + affectedParty : Party
        + occurredAtStep : int
        + getEventMessage() : String
        + toString() : String
    }

    class ScandalScheduler {
        - distributionProvider : DistributionProvider
        + ScandalScheduler(distributionProvider : DistributionProvider)
        + shouldScandalOccur() : boolean
        + reset() : void
    }

    class ScandalImpactCalculator {
        - maxParties : int
        + ScandalImpactCalculator(maxParties : int)
        + calculateAcutePressure(scandals : List<ScandalEvent>, parties : List<Party>, currentStep : int) : double[]
        + processRecovery(parties : List<Party>, populationSize : int) : void
        + reset() : void
    }
}

package "de.schulprojekt.duv.model.voter" #LIGHTCORAL {
    class VoterPopulation {
        - {static} UNDECIDED_RATIO : double
        - {static} POS_MEAN : double
        - {static} POS_STD_DEV : double
        - {static} MEDIA_INFLUENCE_EXPONENT : double
        - voterPartyIndices : byte[]
        - voterTypes : byte[]
        - voterLoyalties : float[]
        - voterPositions : float[]
        - voterMediaInfluence : float[]
        + size() : int
        + getPartyIndex(i : int) : byte
        + getVoterType(i : int) : VoterType
        + getPosition(i : int) : float
        + getLoyalty(i : int) : float
        + getMediaInfluence(i : int) : float
        + setPartyIndex(i : int, idx : byte) : void
        + setPosition(i : int, pos : float) : void
        + initialize(totalVoters : int, partyCount : int, distProvider : DistributionProvider) : void
        - selectVoterType(rnd : ThreadLocalRandom) : int
        - validateIndex(index : int) : void
    }

    class VoterBehavior {
        + VoterBehavior()
        + processVoterDecisions(population : VoterPopulation, parties : List<Party>, params : SimulationParameters, acutePressures : double[], impactCalc : ScandalImpactCalculator) : List<VoterTransition>
    }

    enum VoterType {
        PRAGMATIC
        IDEOLOGICAL
        RATIONAL_CHOICE
        AFFECTIVE
        HEURISTIC
        POLITIKFERN
        - loyaltyModifier : double
        - mediaModifier : double
        - distanceSensitivity : double
        + getLoyaltyModifier() : double
        + getMediaModifier() : double
        + getDistanceSensitivity() : double
    }
}

package "de.schulprojekt.duv.model.dto" #LAVENDER {
    class VoterTransition <<record>> {
        + voterIndex : int
        + fromParty : Party
        + toParty : Party
        + reason : String
    }
}

package "de.schulprojekt.duv.model.random" #LIGHTCYAN {
    class DistributionProvider {
        + initialize(params : SimulationParameters) : void
        + sampleLoyalty() : double
    }
}

' ===== UTILITY LAYER =====
package "de.schulprojekt.duv.util.io" #WHEAT {
    class CSVLoader {
        + getRandomScandal() : Scandal
        + loadPartyTemplates() : List<PartyTemplate>
    }
}

package "de.schulprojekt.duv.util.config" #KHAKI {
    class PartyConfig <<utility>> {
        + {static} MIN_POSITION : double
        + {static} MAX_POSITION : double
        + {static} MIN_BUDGET : double
        + {static} MIN_SUPPORTERS : int
        + {static} isValidPosition(pos : double) : boolean
        + {static} getOrientationName(pos : double) : String
    }

    class SimulationConfig <<utility>> {
        + {static} UNDECIDED_NAME : String
        + {static} SCANDAL_MAX_AGE_TICKS : int
    }

    class ScandalConfig <<utility>> {
        + {static} RECOVERY_RATE_PER_TICK : double
        + {static} SCANDAL_HALF_LIFE_TICKS : double
    }

    class VoterBehaviorConfig <<utility>> {
        + {static} SWITCHING_THRESHOLD : double
        + {static} DISTANCE_WEIGHT : double
    }
}

package "de.schulprojekt.duv.util.validation" #PALEGOLDENROD {
    class ParameterValidator <<utility>> {
        + {static} validate(params : SimulationParameters) : void
        + {static} isInvalid(params : SimulationParameters) : boolean
        + {static} getValidationError(params : SimulationParameters) : String
        + {static} clampInt(value : int, min : int, max : int) : int
        + {static} getMinTickRate() : int
        + {static} getMaxTickRate() : int
    }

    enum ValidationMessage {
        INVALID_PARAMETERS_REJECTED
        POPULATION_OUT_OF_RANGE
        MEDIA_INFLUENCE_OUT_OF_RANGE
        + format(args : Object...) : String
    }
}

' ===== RELATIONSHIPS =====

' Controller relationships
SimulationController "1" *-- "1" SimulationEngine : orchestrates
SimulationController "1" o-- "1" DashboardController : updates

' View relationships
Main ..> StartController : creates
Main ..> DashboardController : creates
DashboardController "1" ..> "1" SimulationController : controls
DashboardController ..> StatisticsController : uses
DashboardController ..> ParliamentController : uses

' Model Core relationships
SimulationEngine "1" *-- "1" SimulationState : contains
SimulationEngine "1" o-- "1" SimulationParameters : uses
SimulationEngine "1" *-- "1" PartyRegistry : manages
SimulationEngine "1" *-- "1" VoterPopulation : manages
SimulationEngine "1" *-- "1" VoterBehavior : uses
SimulationEngine "1" *-- "1" ScandalScheduler : uses
SimulationEngine "1" *-- "1" ScandalImpactCalculator : uses
SimulationEngine "1" *-- "1" DistributionProvider : uses
SimulationEngine "1" o-- "1" CSVLoader : uses

SimulationState "1" o-- "*" ScandalEvent : manages

' Party relationships
PartyRegistry "1" o-- "*" Party : manages
PartyRegistry "1" o-- "1" CSVLoader : uses

' Scandal relationships
ScandalEvent "1" o-- "1" Scandal : references
ScandalEvent "1" o-- "1" Party : references
ScandalScheduler "1" o-- "1" DistributionProvider : uses

' Voter relationships
VoterPopulation "1" ..> "1" VoterType : uses
VoterPopulation "1" ..> "1" DistributionProvider : uses
VoterBehavior "1" ..> "1" VoterPopulation : processes
VoterBehavior "1" ..> "*" Party : evaluates
VoterBehavior "1" ..> "*" VoterTransition : creates
VoterBehavior "1" ..> "1" ScandalImpactCalculator : uses

' Utility relationships
CSVLoader "1" ..> "*" Scandal : loads
CSVLoader "1" ..> "*" PartyTemplate : loads
VoterTransition "1" o-- "2" Party : references

' Config usage
Party ..> PartyConfig : validates
SimulationEngine ..> SimulationConfig : uses
ScandalImpactCalculator ..> ScandalConfig : uses
VoterBehavior ..> VoterBehaviorConfig : uses

' Validation usage
SimulationController ..> ParameterValidator : validates
SimulationController ..> ValidationMessage : uses

@enduml
